# 蓝鲸平台7.1版本在线部署方案



[TOC]



------

## 一、**蓝鲸平台部署资源准备指南**

**版本**：7.1
**最后更新**​：2025-06-06

------

### **1. 文档概述**

本文档定义了部署蓝鲸平台所需的硬件、软件、网络及环境要求，适用于生产环境部署规划。

------

### **2. 网络要求**

#### **2.1 带宽要求**

- **最小公网带宽**：50Mbps（建议100Mbps以上以加速镜像下载）
- **低带宽影响**：可能导致Docker镜像拉取超时，延长部署时间

#### **2.2 访问权限**

| 角色    | 必须访问的端点                                               |
| ------- | ------------------------------------------------------------ |
| 中控机  | - 蓝鲸静态文件分发站点：`https://bkopen-1252002024.file.myqcloud.com` - Helm仓库：`https://hub.bktencent.com/` |
| K8s集群 | - Docker Hub：`https://docker.io` - 蓝鲸Docker仓库：`https://hub.bktencent.com/` |

------

### **3. 硬件要求**

#### **3.1 中控机（部署操作节点）**

| 配置项   | 最低要求   | 推荐配置         |
| -------- | ---------- | ---------------- |
| CPU      | 2核        | 4核              |
| 内存     | 2GB        | 8GB              |
| 磁盘     | 100GB      | 200GB（SSD推荐） |
| 操作系统 | CentOS 7.x | CentOS 7.9       |

**备注**：

- 可复用现有运维机，或使用K8s集群中的Master节点（需评估资源占用）。

#### **3.2 K8s集群节点**

##### **3.2.1 角色定义**

- **Master节点**：集群管理节点（控制平面）
- **Node节点**：业务工作负载节点（数据平面）

##### **3.2.2 资源规格**

| 节点类型 | 最低配置       | 推荐配置        | 存储要求                        |
| -------- | -------------- | --------------- | ------------------------------- |
| Master   | 4核/8GB/100GB  | 8核/16GB/200GB  | /data目录≥100GB（本地存储场景） |
| Node     | 8核/32GB/100GB | 16核/64GB/500GB | /data目录≥90GB（本地存储场景）  |

**存储性能要求**：

- **本地存储**：磁盘IO≥100op/s
- **动态存储（如NFS）**：IOPS≥300op/s，可用空间≥230GB

------

### **4. 软件要求**

#### **4.1 操作系统**

- **发行版**：CentOS 7.9 64位

- 验证命令：

  ```
  cat /etc/centos-release
  ```

#### **4.2 内核与系统配置**

| 配置项     | 要求     | 验证命令                     |
| ---------- | -------- | ---------------------------- |
| Kernel版本 | ≥3.10.0  | `uname -r`                   |
| Swap       | 必须关闭 | `free -m`（Swap行值为0）     |
| 防火墙     | 必须关闭 | `iptables -vnL`（无规则）    |
| SELinux    | 必须禁用 | `getenforce`（输出Disabled） |

#### **4.3 时间同步**

- 时区：统一设置为北京时间（Asia/Shanghai）

  ```
  timedatectl set-timezone Asia/Shanghai
  ```

- **时间同步服务**：部署Chrony或NTP

#### **4.4 容器与K8s环境**

| 组件     | 版本要求              | 验证命令          |
| -------- | --------------------- | ----------------- |
| Docker   | ≥19.03                | `docker version`  |
| Kubelet  | 1.20-1.23             | `kubectl version` |
| **注意** | 1.24+版本需验证兼容性 |                   |

------

### **5. 资源评估表**

| 蓝鲸套餐     | 最低Node数 | 推荐Node数 | 备注                     |
| ------------ | ---------- | ---------- | ------------------------ |
| 基础套餐     | 2.5        | 3          | 后台及SaaS服务           |
| 容器管理平台 | 0.7        | 1          | 容器管理后台及SaaS       |
| 监控套餐     | 1.5        | 2          | 启用容器监控需≥500GB存储 |
| 持续集成套餐 | 2          | 5          | 流水线任务多时需扩容     |

------





## 二、**Docker Registry V2 缓存代理部署方案**

### **1. 部署概述**

在Node节点所在网络部署具备缓存能力的Docker Registry代理服务，通过缓存常用镜像减少公网带宽消耗，提升镜像拉取速度。
 ​**核心优势**​：

- 带宽需求：代理服务器需至少1Gbps带宽
- 缓存机制：支持镜像层缓存（blobdescriptor inmemory）
- 高可用：容器自动重启策略（`--restart=always`）

------

### **2. 部署准备**

#### **2.1 环境要求**

| 项目       | 要求                           |
| ---------- | ------------------------------ |
| 部署位置   | Node节点所在网络（独立服务器） |
| 最小带宽   | 1Gbps                          |
| 存储空间   | 根据镜像体积预留≥100GB磁盘     |
| Docker版本 | ≥19.03                         |

#### **2.2 变量定义**

```
upstream_name=bkhub          # 上游仓库名称
upstream_url=https://hub.bktencent.com  # 上游仓库地址
proxy_port=5500              # 代理服务端口
proxy_instance_name=proxy-$upstream_name  # 容器实例名称
proxy_config_dir=/etc/docker/registry    # 配置文件目录
proxy_config_file=$proxy_config_dir/$upstream_name.yaml  # 配置文件路径
proxy_data_dir=/var/lib/registry-$upstream_name  # 镜像存储目录
```

------

### **3. 部署步骤**

#### **3.1 创建目录与配置文件**

```
# 创建目录结构
mkdir -p "$proxy_config_dir" "$proxy_data_dir"

# 生成Registry配置文件
cat > "$proxy_config_file" <<EOF
version: 0.1
http:
  addr: :5000
  net: tcp
  secret: $upstream_name-$proxy_port
  headers:
    X-Content-Type-Options: [nosniff]
storage:
  filesystem:
    rootdirectory: /var/lib/registry
cache:
  blobdescriptor: inmemory  # 内存缓存镜像元数据
redirect:
  disable: true             # 禁用重定向（强制本地代理）
delete:
  enabled: true             # 允许删除镜像
proxy:
  remoteurl: $upstream_url  # 上游仓库地址
EOF
```

#### **3.2 部署Docker容器**

```
# 检查容器是否存在
if docker inspect "$proxy_instance_name" &>/dev/null; then
  echo "[INFO] $proxy_instance_name 已存在，执行重启..."
  docker restart "$proxy_instance_name"
else
  echo "[INFO] 部署新容器: $proxy_instance_name"
  docker run -d \
    -p $proxy_port:5000 \
    --restart=always \
    --name "$proxy_instance_name" \
    -v "$proxy_config_file":/etc/docker/registry/config.yml \
    -v "$proxy_data_dir":/var/lib/registry \
    hub.bktencent.com/library/registry:2
fi
```

------

### **4. 验证代理功能**

#### **4.1 测试镜像拉取**

```
# 首次拉取（从上游下载）
time docker pull 127.0.0.1:5500/blueking/slug-app:v1.1.0-beta.27

# 删除本地镜像缓存
docker rmi 127.0.0.1:5500/blueking/slug-app:v1.1.0-beta.27

# 第二次拉取（从本地缓存读取）
time docker pull 127.0.0.1:5500/blueking/slug-app:v1.1.0-beta.27
```

**预期结果**：

- 首次拉取时间较长（依赖公网速度）
- 第二次拉取时间显著缩短（验证缓存生效）

#### **4.2 多Node节点配置**

在K8s集群的各Node节点上配置Docker Daemon，将镜像仓库地址指向代理服务器：

```
{
  "registry-mirrors": ["http://<代理服务器IP>:5500"]
}
```

**生效方式**：重启Docker服务或Node节点。

------

### **5. 维护与监控**

#### **5.1 日常维护**

- 日志查看：

  ```
  docker logs -f "$proxy_instance_name"
  ```

- **存储清理**：
   手动删除`$proxy_data_dir`中的过期镜像（需确保无Node正在使用）。

#### **5.2 性能监控**

- **缓存命中率**：通过Docker Registry API获取统计信息
- **带宽节省**：对比代理服务器与Node节点的公网流量差异

------

### **6. 常见问题**

#### **Q1: 拉取镜像时报错`500 Internal Server Error`**

- **可能原因**：上游仓库不可达或配置错误

- 解决方案：

  ```
  # 检查容器日志
  docker logs "$proxy_instance_name"
  
  # 验证上游仓库连通性
  curl -I $upstream_url/v2/
  ```

#### **Q2: 如何扩展存储空间？**

- 步骤：
  1. 挂载新的磁盘到`$proxy_data_dir`目录
  2. 或修改`proxy_data_dir`路径指向更大容量的存储





------

## 三、**使用 bcs.sh 快速部署 Kubernetes 集群**

### **1. 部署概述**

通过蓝鲸提供的 `bcs.sh` 脚本快速部署高可用 Kubernetes 集群，支持动态扩容节点及配置优化。
 ​**核心优势**​：

- 自动化部署：一键初始化 Master 节点
- 弹性扩容：支持 Master/Node 节点动态扩展
- 高可用架构：Master 节点建议部署奇数台（1/3/5）

------

### **2. 部署初始 Master 节点**

#### **2.1 执行部署命令**

在**第一台 Master 机器**（建议复用中控机）执行以下命令：

```
curl -fsSL https://bkopen-1252002024.file.myqcloud.com/ce7/bcs.sh | bash -s -- -i k8s
```

#### **2.2 验证部署成功**

- 成功输出示例：

  ```
  [INFO] Kubernetes cluster initialized successfully
  [INFO] kubectl command is now available
  ```

- 验证命令：

  ```
  kubectl version --client
  ```

------

### **3. 扩容集群节点**

#### **3.1 获取扩容命令**

在初始 Master 节点执行以下命令获取扩容脚本：

```
curl -fsSL https://bkopen-1252002024.file.myqcloud.com/ce7/bcs.sh | bash -s -- -i k8sctrl
```

#### **3.2 扩容类型选择**

根据输出选择对应命令（示例）：

| 扩容类型 | 命令位置     | 关键要求                |
| -------- | ------------ | ----------------------- |
| Master   | 扩容控制平面 | 总数量需为奇数（1/3/5） |
| Node     | 扩容节点     | 无数量限制              |

**重要提示**：

- Master 节点扩容后需参考 [K8s 官方文档](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/) 配置高可用。
- 同一类型节点使用相同命令扩容。

#### **3.3 执行扩容操作**

在目标机器上粘贴对应命令，成功输出示例：

```
[INFO]: 添加Kubernetes节点成功
[INFO]: LAN_IP: 10.0.0.5
```

------

### **4. 可选配置**

#### **4.1 调整 Dockerd 配置（内网镜像加速）**

若使用内网 Docker Registry，需根据协议类型配置：

| 协议类型 | 配置项                | 示例                                       |
| -------- | --------------------- | ------------------------------------------ |
| HTTP     | `insecure-registries` | `--insecure-registries=10.0.0.1:5000`      |
| HTTPS    | 证书挂载              | `/etc/docker/certs.d/registry:5000/ca.crt` |

#### **4.2 同步配置到中控机**

若中控机与 Master 分离，需同步关键配置：

```
# 替换变量后执行
master_ip=10.0.0.2  # 修改为实际Master IP
mkdir -p ~/.kube
scp "$master_ip":~/.kube/config ~/.kube/config  # 同步kubeconfig
grep bcs.local /etc/hosts || ssh "$master_ip" grep bcs.local /etc/hosts | tee -a /etc/hosts  # 同步hosts
scp "$master_ip":/usr/bin/kubectl /usr/bin/   # 同步kubectl二进制
```

------

### **5. 下一步操作**

1. 完成中控机配置（参考[《准备中控机》文档](https://tencent.yuanbao/链接)）

2. 验证集群状态：

   ```
   kubectl get nodes -o wide
   ```

------

### **6. 常见问题**

#### **Q1: 扩容命令执行失败**

- 排查步骤：

  1. 检查目标机器是否满足[硬件要求](https://tencent.yuanbao/文档链接)

  2. 查看 Master 节点日志：

     ```
     journalctl -u kubelet -f
     ```

#### **Q2: 如何扩展 Master 节点至5台？**

- 操作流程：
  1. 执行扩容命令添加第3/4/5台Master
  2. 参考 [K8s 官方高可用指南](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/) 配置 etcd 和负载均衡





## **四、基础套餐--自定义配置**

### **1. 部署概述**

本指南描述如何通过 Helmfile 模板快速部署蓝鲸基础套餐（存储服务+后台服务），包含环境准备、配置文件生成及核心组件安装流程。

------

### **2. 环境准备**

#### **2.1 下载安装文件**

在中控机执行下载脚本，获取 Helmfile 包及公共证书：

```
bkdl-7.1-stable.sh -ur latest base demo
```

- **默认路径**：`~/bkce7.1-install/`

#### **2.2 目录结构说明**

完整安装目录包含以下子目录：

```
|-- bin/                  # 安装工具
|-- blueking/             # 蓝鲸部署主目录（工作目录）
|-- ci-plugins/           # 蓝盾流水线插件
|-- gse2/                 # GSE V2组件
|-- paas-runtimes/        # PaaS运行环境文件
`-- saas/                 # SaaS安装包
```

**工作目录**：

- 默认路径：`~/bkce7.1-install/blueking/`

- 进入命令：

  ```
  cd ~/bkce7.1-install/blueking/
  ```

------

### **3. 核心配置文件**

#### **3.1 Helmfile 模板结构**

基础套餐通过 `base.yaml.gotmpl` 定义，包含以下关键文件引用：

```
bases:
  - env.yaml
---
bases:
  - defaults.yaml
---
helmfiles:
  - path: ./base/storage.yaml.gotmpl      # 存储服务
  - path: ./base/blueking.yaml.gotmpl     # 后台服务
selectors:
  - seq=first/second/third/fourth         # 分批次启动控制
```

#### **3.2 Values 文件体系**

| 文件类型           | 路径示例                                                | 用途说明                   |
| ------------------ | ------------------------------------------------------- | -------------------------- |
| 全局 values        | `environments/default/values.yaml`                      | 所有Release共享的默认配置  |
| 全局 custom-values | `environments/default/custom.yaml`                      | 覆盖全局默认值的自定义配置 |
| Release私有配置    | `./environments/default/<release名>-values.yaml.gotmpl` | 特定Release的配置覆盖      |

------

### **4. 部署基础套餐**

#### **4.1 声明 Release**

以 `bk-repo` 为例，展示配置结构：

```
releases:
  - name: bk-repo
    namespace: {{ .Values.namespace }}  # 默认blueking
    chart: blueking/bkrepo
    version: {{ index .Values.version "bkrepo" }}
    labels:
      seq: first                        # 启动顺序标签
    values:
      - ./environments/default/bkrepo-values.yaml.gotmpl
      - ./environments/default/bkrepo-custom-values.yaml.gotmpl
```

#### **4.2 关键配置项**

##### **4.2.1 域名配置**

在 `custom.yaml` 中定义访问域名：

```
domain:
  bkDomain: bkce7.bktencent.com       # 统一登录Cookie域名
  bkMainSiteDomain: bkce7.bktencent.com  # 主站入口域名
```

##### **4.2.2 日志目录配置**

确保所有Node节点Docker日志路径一致，并在 `custom.yaml` 中声明：

```
apps:
  bkappFilebeat:
    containersLogPath: "/var/lib/docker/containers"  # 替换为实际路径
```

------

### **5. 预部署配置**

#### **5.1 添加 Helm Charts 仓库**

```
helm repo add blueking https://hub.bktencent.com/chartrepo/blueking
helm repo update
```

#### **5.2 配置 Docker Registry（内网场景）**

```
export REGISTRY=代理IP:端口  # 中控机环境变量
```

**Node节点要求**：

- 配置TLS证书或设置 `insecure-registries`

#### **5.3 生成关键配置文件**

```
# 生成App Secret
./scripts/generate_app_secret.sh ./environments/default/app_secret.yaml

# 生成API网关密钥对
./scripts/generate_rsa_keypair.sh ./environments/default/bkapigateway_builtin_keypair.yaml

# 创建PaaS集群管理员
./scripts/create_k8s_cluster_admin_for_paas3.sh
```

------

### **6. 安装入口网关**

#### **6.1 检查 Ingress Controller**

```
kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx
```

#### **6.2 部署 Ingress Controller**

若未部署，执行：

```
helmfile -f 00-ingress-nginx.yaml.gotmpl sync
```

#### **6.3 配置 CoreDNS**

将蓝鲸域名解析注入集群DNS：

```
cd ~/bkce7.1-install/blueking/
BK_DOMAIN=$(yq e '.domain.bkDomain' environments/default/custom.yaml)
IP1=$(kubectl get svc -A -l app.kubernetes.io/instance=ingress-nginx -o jsonpath='{.items[0].spec.clusterIP}')
./scripts/control_coredns.sh update "$IP1" $BK_DOMAIN bkrepo.$BK_DOMAIN docker.$BK_DOMAIN ...
```

**验证配置**：

```
./scripts/control_coredns.sh list
```

预期输出示例：

```
10.244.0.5 bkce7.bktencent.com
10.244.0.5 apps.bkce7.bktencent.com
...
```

------

### **7. 下一步操作**

1. 执行基础套餐部署：

   ```
   ./scripts/setup_bkce7.sh
   ```

2. 验证集群状态：

   ```
   kubectl get pods -n blueking -o wide
   ```

------

### **8. 常见问题**

#### **Q1: Ingress Controller 部署失败**

- 排查步骤：

  1. 检查网络插件是否正常（如Calico）

  2. 查看事件日志：

     ```
     kubectl get events -A
     ```

#### **Q2: CoreDNS 注入后解析失败**

- **可能原因**：Service IP变动未更新

- 解决方案：

  1. 重新执行 `control_coredns.sh update`

  2. 检查CoreDNS Pod日志：

     ```
     kubectl logs -n kube-system -l k8s-app=kube-dns
     ```

------

**附录**：

- [Helmfile 官方文档](https://helmfile.readthedocs.io/)
- [Kubernetes CoreDNS 配置指南](https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/)

**版本记录**：

- v1.0 - 初始版本
- v1.1 - 补充域名配置和CoreDNS验证步骤







## **五、基础套餐--存储服务部署**

### **1. 部署概述**

本指南描述蓝鲸基础套餐中存储服务的部署流程，包括本地PV供应、预置数据库服务部署及已有存储服务对接方案。

------

### **2. 供应本地存储卷 (LocalPV)**

#### **2.1 检查现有存储类**

在中控机执行以下命令：

```
kubectl get sc
```

- **若无输出**：需按本文档配置LocalPV
- **若存在`xxx (default)`**：已配置默认存储类，可跳过本章节

#### **2.2 磁盘空间准备**

确保所有Node节点为LocalPV源目录预留≥100GB可用空间：

```
df -h /mnt/blueking/  # 检查目标目录空间
```

#### **2.3 PV目录制备**

##### **2.3.1 默认目录（bcs.sh自动制备）**

若使用bcs.sh部署K8s集群，已默认在Node节点创建PV目录（`/mnt/blueking/`），可跳过此步骤。

##### **2.3.2 手动制备目录（含Master节点）**

在Node节点执行以下命令：

```
# 定义源目录和目标目录（需与values文件一致）
src_dir=/data/bcs/localpv/          # 源数据目录（自定义，需≥100GB空间）
pv_host_dir=/mnt/blueking/          # PV挂载目录（默认值）

# 创建20个PV所需目录
for i in {01..20}; do
  vol="vol$i"
  vol_dir="${pv_host_dir%/}/$vol"
  vol_src="${src_dir%/}/$vol"
  mkdir -p "$vol_dir" "$vol_src"
  
  # 检查并添加fstab挂载项
  if grep -w "$vol_dir" /etc/fstab; then
    echo "TIP: $vol_dir 已存在于/etc/fstab"
  else
    echo "$vol_src $vol_dir none defaults,bind 0 0" | tee -a /etc/fstab
  fi
done

# 挂载所有目录
mount -va
```

**验证挂载结果**：

```
grep -w vol[0-9][0-9] /etc/fstab /proc/self/mounts
```

#### **2.4 创建PV**

在工作目录执行以下命令：

```
cd ~/bkce7.1-install/blueking
helmfile -f 00-localpv.yaml.gotmpl sync
```

**验证PV创建**：

```
kubectl get pv
```

预期输出示例：

```
NAME                CAPACITY   ACCESS MODES   STATUS      AGE
local-pv-18c3e0ef   98Gi       RWO            Available   6d8h
```

------

### **3. 部署蓝鲸预置存储服务**

通过以下命令并行部署所有预置存储服务：

```
cd ~/bkce7.1-install/blueking
helmfile -f base-storage.yaml.gotmpl sync
```

#### **3.1 单独部署指定服务**

如需单独部署某个服务，使用`-l name=<服务名>`参数：

```
# 示例：单独部署MySQL
helmfile -f base-storage.yaml.gotmpl -l name=bk-mysql sync

# 其他服务部署命令
helmfile -f base-storage.yaml.gotmpl -l name=bk-rabbitmq sync
helmfile -f base-storage.yaml.gotmpl -l name=bk-redis sync
helmfile -f base-storage.yaml.gotmpl -l name=bk-mongodb sync
helmfile -f base-storage.yaml.gotmpl -l name=bk-elastic sync
helmfile -f base-storage.yaml.gotmpl -l name=bk-zookeeper sync
helmfile -f base-storage.yaml.gotmpl -l name=bk-etcd sync
```

------

### **4. 对接已有存储服务**

#### **4.1 禁用内置服务**

修改全局`custom.yaml`文件，禁用Bitnami MySQL：

```
bitnamiMysql:
  enabled: false  # 关键配置项
```

#### **4.2 配置外部MySQL连接**

在`custom.yaml`中覆盖MySQL连接参数：

```
mysql:
  host: "填写服务端IP"      # 外部MySQL地址
  port: 3306               # 默认端口
  rootPassword: "填写root密码"  # 需与外部MySQL一致
```

#### **4.3 权限与数据库准备**

##### **4.3.1 检查Root权限**

在MySQL执行以下命令：

```
SHOW GRANTS FOR root@'%';
```

若无`GRANT OPTION`权限，需执行：

```
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

##### **4.3.2 预创建数据库**

在MySQL中执行以下SQL脚本（共20+数据库）：

```
CREATE DATABASE IF NOT EXISTS open_paas DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
CREATE DATABASE IF NOT EXISTS bk_login DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
-- 其他数据库创建语句...（完整列表见文档）
```

------

### **5. 自定义配置**

#### **5.1 修改全局Values**

如需调整存储路径等参数，编辑`environments/default/values.yaml`：

```
localpv:
  hostDir: /mnt/blueking/  # 修改PV挂载目录（需与制备目录一致）
```

#### **5.2 覆盖配置（推荐）**

通过`custom.yaml`覆盖默认值，避免直接修改模板文件：

```
cat >> environments/default/custom.yaml <<EOF
localpv:
  hostDir: /data/custom_pv/  # 自定义PV目录

mysql:
  host: "10.0.0.100"         # 外部MySQL地址
EOF
```

------

### **6. 验证与下一步**

#### **6.1 验证存储服务状态**

```
kubectl get pods -n blueking -l app.kubernetes.io/component=storage
```

------

### **7. 常见问题**

#### **Q1: PV创建后状态为Pending**

- #### 排查步骤：

  1. 检查Node节点是否已正确挂载目录：

     ```
     mount | grep /mnt/blueking
     ```

  2. 查看PV事件详情：

     ```
     kubectl describe pv <pv名称>
     ```

#### **Q2: MySQL连接失败**

- **可能原因**：网络策略或防火墙限制

- 解决方案：

  1. 检查Service和Endpoint状态：

     ```
     kubectl get svc,ep -n blueking
     ```

  2. 验证网络连通性：

     ```
     kubectl run test-mysql --rm -it --image=mysql:5.7 -- bash
     mysql -h bk-mysql-mysql -u root -p
     ```

------

**附录**：

- [Kubernetes LocalPV官方文档](https://kubernetes.io/docs/concepts/storage/volumes/#local)
- [MySQL权限管理指南](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html)

**版本记录**：

- v1.0 - 初始版本
- v1.1 - 补充PV目录制备和权限检查步骤







## **六、基础套餐--后台部署指南**

### **1. 部署概述**

本指南描述蓝鲸基础套餐后台组件的分层部署流程，包含5个顺序层级（seq=first至seq=fourth）的Release部署步骤及访问配置方法。

------

### **2. 前置条件**

- 已完成[自定义配置](https://tencent.yuanbao/链接)
- 已完成[存储服务部署](https://tencent.yuanbao/链接)

------

### **3. 分层部署流程**

#### **3.1 部署 seq=first 的 Release**

**包含组件**：`bk-repo`（制品库）、`bk-auth`（认证服务）、`bk-apigateway`（API网关）

**部署命令**：

```
helmfile -f base-blueking.yaml.gotmpl -l seq=first sync
```

**关键组件说明**：

- bk-apigateway：
  - 支持RabbitMQ作为Celery Broker（生产环境推荐）
  - 参考Issue：[GitHub #275](https://github.com/TencentBlueKing/blueking-apigateway/issues/275)

------

#### **3.2 部署 seq=second 的 Release**

**包含组件**：`bk-iam`（权限中心后台）、`bk-ssm`（参数管理）、`bk-console`（蓝鲸桌面）

**部署命令**：

```
helmfile -f base-blueking.yaml.gotmpl -l seq=second sync
```

**分步操作**：

1. 权限中心后台：

   ```
   helmfile -f base-blueking.yaml.gotmpl -l name=bk-iam -l name=bk-ssm sync
   ```

2. 蓝鲸桌面：

   ```
   helmfile -f base-blueking.yaml.gotmpl -l name=bk-console sync
   ```

------

#### **3.3 部署 seq=third 的 Release**

**包含组件**：`bk-user`（用户管理）、`bk-gse`（管控平台）、`bk-cmdb`（配置平台）、PaaS平台相关组件

**部署命令**：

```
helmfile -f base-blueking.yaml.gotmpl -l seq=third sync
```

**分步操作**：

1. 用户管理：

   ```
   helmfile -f base-blueking.yaml.gotmpl -l name=bk-user sync
   ```

2. 权限中心应用：

   ```
   helmfile -f base-blueking.yaml.gotmpl -l name=bk-iam-saas -l name=bk-iam-search-engine sync
   ```

3. 管控平台与配置平台：

   ```
   helmfile -f base-blueking.yaml.gotmpl -l name=bk-gse sync
   helmfile -f base-blueking.yaml.gotmpl -l name=bk-cmdb sync
   ```

4. PaaS平台：

   ```
   helmfile -f base-blueking.yaml.gotmpl -l name=bk-ingress-nginx -l name=bk-ingress-rule sync
   helmfile -f base-blueking.yaml.gotmpl -l name=bk-paas -l name=bkpaas-app-operator -l name=bk-applog sync
   ```

------

#### **3.4 部署 seq=fourth 的 Release**

**包含组件**：`bk-job`（作业平台）

**部署命令**：

```
helmfile -f base-blueking.yaml.gotmpl -l seq=fourth sync
```

------

### **4. 访问蓝鲸桌面**

#### **4.1 配置DNS或Hosts文件**

根据集群网络环境选择以下方式之一：

| 网络环境     | 操作步骤                                                     |
| ------------ | ------------------------------------------------------------ |
| **内网访问** | 获取ingress-nginx Pod所在节点的内网IP（`IP1`），更新Hosts文件 |
| **公网访问** | 获取ingress-nginx Pod所在节点的公网IP（`IP1`），更新Hosts文件 |
| **负载均衡** | 手动指定负载均衡IP（`IP1`），确保后端指向ingress-nginx Pod内网IP |

**获取IP命令**：

```
# 内网IP
IP1=$(kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx -o jsonpath='{.items[0].status.hostIP}')

# 公网IP（需SSH到节点查询）
IP1=$(ssh $(kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx -o jsonpath='{.items[0].status.hostIP}') 'curl -sSf ip.sb')
```

**生成Hosts配置**：

```
cd ~/bkce7.1-install/blueking/
BK_DOMAIN=$(yq e '.domain.bkDomain' environments/default/custom.yaml)
cat <<EOF | scripts/update-hosts-file.sh /etc/hosts /etc/hosts
$IP1 $BK_DOMAIN
$IP1 bkrepo.$BK_DOMAIN
$IP1 docker.$BK_DOMAIN
$IP1 helm.$BK_DOMAIN
$IP1 bkpaas.$BK_DOMAIN
$IP1 bkuser.$BK_DOMAIN
$IP1 bkapi.$BK_DOMAIN
$IP1 apigw.$BK_DOMAIN
$IP1 bkiam.$BK_DOMAIN
$IP1 cmdb.$BK_DOMAIN
$IP1 job.$BK_DOMAIN
$IP1 bknodeman.$BK_DOMAIN
$IP1 apps.$BK_DOMAIN
$IP1 bcs.$BK_DOMAIN
$IP1 bklog.$BK_DOMAIN
$IP1 bkmonitor.$BK_DOMAIN
$IP1 devops.$BK_DOMAIN
$IP1 codecc.$BK_DOMAIN
$IP1 lesscode.$BK_DOMAIN
$IP1 bk-apicheck.$BK_DOMAIN
EOF
```

------

#### **4.2 添加桌面应用**

为管理员用户（admin）预装应用：

```
scripts/add_user_desktop_app.sh -u "admin" -a "bk_cmdb,bk_job"
scripts/add_user_desktop_app.sh -u "admin" -a "bk_usermgr"
scripts/set_desktop_default_app.sh -a "bk_usermgr"  # 设为默认应用
```

**注意**：若提示`user(admin) not exists`，表示用户未登录，可忽略报错。

------

#### **4.3 获取访问凭证**

**登录账户**：

```
kubectl get cm -n blueking bk-user-api-general-envs -o go-template='user={{.data.INITIAL_ADMIN_USERNAME}}{{"
"}}password={{ .data.INITIAL_ADMIN_PASSWORD }}{{"
"}}'
```

输出示例：

```
user=admin
password=BlueKing@123
```

**访问地址**：

```
cd ~/bkce7.1-install/blueking/
BK_DOMAIN=$(yq e '.domain.bkDomain' environments/default/custom.yaml)
echo "http://$BK_DOMAIN"
```

------

### **5. 下一步操作**

完成以下SaaS运行环境准备工作：

1. [确保Node节点能拉取SaaS镜像](https://tencent.yuanbao/链接)
2. [上传PaaS Runtimes到制品库](https://tencent.yuanbao/链接)
3. [配置SaaS专用Node节点（可选）](https://tencent.yuanbao/链接)

------

### **6. 常见问题**

#### **Q1: Hosts文件更新后仍无法访问**

- 排查步骤：

  1. 检查DNS解析是否生效：

     ```
     nslookup $BK_DOMAIN
     ```

  2. 验证ingress-nginx服务状态：

     ```
     kubectl get svc -n blueking ingress-nginx
     ```

#### **Q2: 如何扩展PaaS平台组件**

- 操作流程：
  1. 修改`values.yaml`中相关组件的replica数量
  2. 执行`helmfile -f base-blueking.yaml.gotmpl sync`更新部署

------

**附录**：

- [Kubernetes Ingress-Nginx配置指南](https://kubernetes.github.io/ingress-nginx/)
- [蓝鲸API网关架构说明](https://tencent.yuanbao/链接)

**版本记录**：

- v1.0 - 初始版本
- v1.1 - 补充Hosts文件更新验证方法





## **七、蓝鲸PaaS镜像仓库访问配置指南**

### **1. 部署背景**

从蓝鲸7.0版本开始，PaaS默认使用image格式的S-Mart包，部署过程中需访问蓝鲸制品库的Docker Registry服务。本指南详细说明如何配置Node节点的DNS解析及Docker运行时访问权限。

------

### **2. 配置Node DNS解析**

#### **2.1 配置目标**

确保Node节点能通过域名`docker.$BK_DOMAIN`访问蓝鲸制品库的Docker Registry服务。

#### **2.2 配置方法**

##### **2.2.1 生成Hosts配置项**

在中控机执行以下命令：

```
cd ~/bkce7.1-install/blueking/  # 进入工作目录
BK_DOMAIN=$(yq e '.domain.bkDomain' environments/default/custom.yaml)  # 从自定义配置提取域名
IP1=$(kubectl get svc -A -l app.kubernetes.io/instance=ingress-nginx -o jsonpath='{.items[0].spec.clusterIP}')  # 获取Ingress-Nginx ClusterIP
echo "$IP1 docker.$BK_DOMAIN"  # 输出Hosts配置项
```

##### **2.2.2 更新Node节点配置**

- **方案A：修改各Node的`/etc/hosts`文件**
   将生成的`$IP1 docker.$BK_DOMAIN`记录添加到所有Node节点的`/etc/hosts`文件中。
- **方案B：通过DNS服务器解析**
   在集群DNS系统中添加`docker.$BK_DOMAIN`的A记录，指向`$IP1`。

------

### **3. 验证DNS配置**

在所有Node节点执行以下命令，验证域名解析是否生效：

```
curl -v docker.bkce7.bktencent.com/v2/
```

**预期结果**：

- 成功解析IP并建立连接
- 返回认证提示（如`401 Unauthorized`）

**故障排查**：

- 若解析失败，检查`/etc/hosts`或DNS记录是否正确

- 检查Ingress-Nginx服务状态：

  ```
  kubectl get svc -n blueking ingress-nginx
  ```

------

### **4. 配置Docker运行时访问权限**

Kubernetes默认使用HTTPS协议拉取镜像，需额外配置以支持HTTP访问（推荐）或HTTPS证书验证。

#### **4.1 场景一：调整dockerd使用HTTP协议访问Registry（推荐）**

##### **4.1.1 操作步骤**

1. **获取当前配置模板**

   - 若中控机非Master节点，从Master节点复制配置文件：

     ```
     first_master=$(kubectl get nodes -l node-role.kubernetes.io/master -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
     scp "$first_master":/etc/docker/daemon.json daemon.json.orig
     ```

   - 若中控机是Master节点：

     ```
     cp /etc/docker/daemon.json daemon.json.orig
     ```

2. **生成新配置文件**

   ```
   BK_DOMAIN=$(yq e '.domain.bkDomain' environments/default/custom.yaml)
   jq --arg k "insecure-registries" --arg v "docker.$BK_DOMAIN" \
      'if .[$k]|index($v) then . else .[$k]+=[$v] end' \
      daemon.json.orig | tee daemon.json
   ```

3. **分发配置到所有Node节点**

   ```
   all_nodes=$(kubectl get nodes -o jsonpath='{.items[*].status.addresses[?(@.type=="InternalIP")].address}')
   now=$(date +%Y%m%d-%H%M%S)
   for ip in $all_nodes; do
     ssh "$ip" "cp /etc/docker/daemon.json /etc/docker/daemon.json.bak-$now"
     scp daemon.json "$ip":/etc/docker/daemon.json
     ssh "$ip" "diff /etc/docker/daemon.json /etc/docker/daemon.json.bak-$now"
   done
   ```

4. **重载Docker服务**

   ```
   for ip in $all_nodes; do
     ssh "$ip" "systemctl reload dockerd.service || systemctl reload docker.service"
   done
   ```

5. **验证配置生效**

   ```
   for ip in $all_nodes; do
     echo "=== config in $ip : ==="
     ssh "$ip" "docker info | sed -n '/Insecure Registries:/p'"
   done
   ```

   **预期输出**：

   ```
   Insecure Registries: docker.bkce7.bktencent.com 127.0.0.0/8
   ```

#### **4.2 场景二：配合Docker服务默认行为（HTTPS协议）**

##### **4.2.1 技术要点**

- **调整Ingress-Nginx**：为`docker.$BK_DOMAIN`启用SSL并配置证书。
- 更新Node证书库：
  - 商业证书：系统预置Root CA，无需额外操作。
  - 自签名证书：将PEM格式的CA证书添加到`/etc/docker/certs.d/docker.$BK_DOMAIN/ca.crt`，并更新系统Root CA数据库（CentOS 7使用`yum install ca-certificates`）。

##### **4.2.2 注意事项**

- 此场景未经完整测试，需自行研究具体步骤。
- 参考Docker官方SSL配置文档：[Docker SSL配置指南](https://tencent.yuanbao/链接)。

------

### **5. 常见问题**

#### **Q1: 配置后仍无法拉取镜像**

- 排查步骤：

  1. 检查Node节点的`docker info`输出是否包含`docker.$BK_DOMAIN`。

  2. 查看Docker服务日志：

     ```
     journalctl -xeu dockerd.service
     ```

#### **Q2: 如何切换回HTTPS协议**

- 操作流程：
  1. 从配置文件中移除`insecure-registries`项。
  2. 为`docker.$BK_DOMAIN`配置有效的SSL证书。
  3. 重载Docker服务并验证连接。

------

**附录**：

- [Kubernetes Docker配置文档](https://kubernetes.io/docs/concepts/containers/images/)
- [蓝鲸制品库架构说明](https://tencent.yuanbao/链接)

**版本记录**：

- v1.0 - 初始版本
- v1.1 - 补充HTTPS场景技术要点





## **八、蓝鲸PaaS运行时环境（Runtimes）部署指南**

### **1. 部署背景**

蓝鲸V7提供预编译SaaS包（开发者中心部署时选择“image”格式），无需额外配置Runtimes。但存在以下场景需手动部署Runtimes：

- 基于PaaS自行开发应用
- 安装适配V6的S-Mart源码包（格式为`package`）

------

### **2. 下载PaaS Runtimes文件**

#### **2.1 版本适配说明**

本指南默认适配`paas3 1.1.0-beta.43`及以后版本。若使用早期版本，需修改下载脚本参数为`-r paas3-1.0`。

#### **2.2 下载基础文件**

下载公共脚本及资源文件（约12MB）：

```
bkdl-7.1-stable.sh -C ce7/paas-runtimes -ur paas3-1.1 common
```

#### **2.3 下载Python环境**

推荐下载常用Python版本及pip版本（总约130MB）：

```
# Python基础版本
for v in 2.7.18 3.6.8 3.6.12 3.10.5; do
  bkdl-7.1-stable.sh -C ce7/paas-runtimes -r paas3-1.1 python=$v
done

# 兼容Py2/Py3的pip版本
for v in 9.0.2 19.1.1 20.0.2 20.1.1 20.2.3 20.2.4 20.3.4; do
  bkdl-7.1-stable.sh -C ce7/paas-runtimes -r paas3-1.1 pip-whl-py23=$v
done

# 仅支持Py3的pip版本
for v in 21.3.1 22.0.4 22.1.2 22.2.2 22.3.1 23.0.1; do
  bkdl-7.1-stable.sh -C ce7/paas-runtimes -r paas3-1.1 pip-whl=$v
done
```

#### **2.4 下载Node.js环境**

下载4个常用版本（总约100MB）：

```
for v in 12.16.3 14.16.1 10.10.0 16.16.0; do
  bkdl-7.1-stable.sh -C ce7/paas-runtimes -r paas3-1.1 node=$v
done
```

#### **2.5 下载Golang环境**

按需下载指定版本（每个约130MB）：

```
for v in 1.19.1 1.18.6 1.17.10 1.12.17; do
  bkdl-7.1-stable.sh -C ce7/paas-runtimes -ur paas3-1.1 go=$v
done
```

#### **2.6 下载开发框架模板**

```
# Python开发框架模板
bkdl-7.1-stable.sh -C ce7/paas-runtimes -ur paas3-1.1 pysdk

# Node.js开发框架模板
bkdl-7.1-stable.sh -C ce7/paas-runtimes -ur paas3-1.1 nodesdk
```

> **注意**：Golang暂未提供开发框架模板。

------

### **3. 上传文件到制品库**

#### **3.1 配置认证信息**

在中控机执行以下命令，从Secret中读取账户信息并设置环境变量：

```
cd ~/bkce7.1-install/blueking/
source <(kubectl get secret -n blueking bkpaas3-apiserver-bkrepo-envs -o json | \
  jq -r '.data.BLOBSTORE_BKREPO_CONFIG|@base64d|gsub(", ";"\n")|gsub(" "; "")')
```

#### **3.2 执行上传脚本**

```
# 进入工作目录
cd ~/bkce7.1-install/blueking/

# 递归上传所有文件（排除顶层目录）
find ../paas-runtimes/ -mindepth 2 -type f | while read filepath; do
  bucket="${filepath#../paas-runtimes/}"
  bucket="${bucket%%/*}"
  remote="/${filepath#../paas-runtimes/*/*/}"
  remote="${remote%/}/"
  scripts/bkrepo_tool.sh -u "$USERNAME" -p "$PASSWORD" -P "$PROJECT" \
    -i "$ENDPOINT/generic" -n "$bucket" -X PUT -O -R "$remote" -T "$filepath"
  sleep 1
done
```

**上传提示**：

- 若提示文件已存在（HTTP 251012），属正常现象，跳过即可。
- 重复运行脚本时需等待1秒间隔以避免请求冲突。

#### **3.3 验证上传结果**

1. 使用admin账户登录蓝鲸桌面
2. 进入“制品库”应用
3. 切换至`bkpaas`项目，找到`bkpaas3-platform-assets`仓库
4. 逐层展开子目录，确认文件已上传

------

### **4. 补充缺失的Runtimes版本**

若部署时提示缺少特定版本，按以下步骤补充：

#### **4.1 分析缺失文件**

查看制品库404请求日志，定位缺失文件名：

```
kubectl logs -n blueking deploy/bk-repo-bkrepo-generic generic | \
  awk '/\/bkpaas\/.*HTTP\/[0-9.]+" 404/{sub(/.*(GET|HEAD).*/, ""); sub(/ .*/, ""); print}' | \
  tail -n 20  # 检查最近20条记录
```

示例输出：

```
node-v14.16.1-linux-x64.tar.gz
```

#### **4.2 下载并上传缺失版本**

```
# 下载指定版本（示例：Node.js 14.16.1）
bkdl-7.1-stable.sh -C ce7/paas-runtimes -r paas3-1.1 node=14.16.1

# 重新上传文件
cd ~/bkce7.1-install/blueking/
find ../paas-runtimes/ -mindepth 2 -type f | while read filepath; do
  # 同前文上传脚本逻辑
done
```

**注意**：若下载脚本返回404错误，需联系蓝鲸助手排查制品库配置。

------

### **6. 常见问题**

#### **Q1: 上传时提示认证失败**

- 排查步骤：

  1. 检查`BLOBSTORE_BKREPO_CONFIG`变量是否正确加载

  2. 验证Secret是否存在：

     ```
     kubectl get secret -n blueking bkpaas3-apiserver-bkrepo-envs
     ```

#### **Q2: 如何批量下载历史版本**

- 操作流程：
  1. 从制品库日志中提取所有缺失文件名
  2. 编写脚本调用`bkdl-7.1-stable.sh`按文件名规则下载对应版本

------

**附录**：

- [PaaS Runtimes版本兼容性说明](https://tencent.yuanbao/链接)
- [蓝鲸制品库API文档](https://tencent.yuanbao/链接)

**版本记录**：

- v1.0 - 初始版本
- v1.1 - 补充缺失版本排查方法







## **九、基础套餐--SaaS部署指南**

### **1. 部署概述**

本指南描述蓝鲸基础套餐中SaaS应用的部署流程，包括安装包下载、资源池配置、应用创建及模块部署等关键步骤。

------

### **2. 准备工作**

#### **2.1 下载SaaS安装包**

在浏览器中下载以下安装包，并上传至开发者中心：

| 应用名称             | 版本号  | 下载链接                                                     |
| -------------------- | ------- | :----------------------------------------------------------- |
| 流程服务(bk_itsm)    | 2.6.6   | [下载地址](https://bkopen-1252002024.file.myqcloud.com/saas-paas3/bk_itsm/bk_itsm-V2.6.6.tar.gz) |
| 标准运维(bk_sops)    | 3.28.13 | [下载地址](https://bkopen-1252002024.file.myqcloud.com/saas-paas3/bk_sops/bk_sops-V3.28.13.tar.gz) |
| 节点管理(bk_nodeman) | 2.3.2   | 使用Helmfile部署时自动下载Charts，无需手动下载               |

------

### **3. 配置PaaS资源池**

#### **3.1 添加Redis资源池**

1. 登录开发者中心：`http://bkpaas.$BK_DOMAIN`（替换`$BK_DOMAIN`为实际域名）

2. 进入Redis管理页面：`http://bkpaas.$BK_DOMAIN/backend/admin42/platform/pre-created-instances/manage`

3. 在`0shared`行点击**添加实例**，建议添加5-10次（基础套餐占用4个实例）

4. 启用可回收复用开关，并配置连接信息：

   ```
   # 在中控机生成Redis配置JSON
   redis_json_tpl='{"host":"%s","port": %d,"password":"%s"}'
   redis_host="bk-redis-master.blueking.svc.cluster.local"  # 默认Redis地址
   redis_port=6379                                         # 默认端口
   redis_pass=$(kubectl get secret -n blueking bk-redis -o jsonpath="{.data.redis-password}" | base64 --decode)
   printf "$redis_json_tpl\n" "$redis_host" "$redis_port" "$redis_pass" | jq .
   ```

**资源池类型说明**：

- **0shared（共享实例）**：允许多个SaaS复用，需自行规避Key冲突
- **1exclusive（独占实例）**：禁止重复分配，避免Key冲突

------

### **4. 创建SaaS应用**

#### **4.1 创建流程**

1. 登录蓝鲸桌面，进入**开发者中心**
2. 点击**创建应用**，选择**S-Mart应用**
3. 上传安装包，系统自动解析包信息后点击**确认并创建应用**

**常见问题**：

- 若提示“应用ID已存在”，需执行[更新安装包](https://tencent.yuanbao/chat?from=launch&conversation=d8ce4576-ae33-4f4a-b5e8-738a7ca581c1&project_id=&project_name=&HY82=2&HY56=SlidePage#42-更新安装包)流程
- 其他异常请参考《问题案例》文档

#### **4.2 更新安装包**

1. 进入开发者中心**应用开发**界面
2. 选择目标应用，进入**包版本管理**
3. 点击**上传新版本**，按创建应用流程重新上传

------

### **5. 部署SaaS应用**

#### **5.1 流程服务(bk_itsm)**

1. 进入**部署管理**界面
2. 选择**default模块**（唯一模块）
3. 切换至**生产环境**，在**选择部署分支**中选择`image`分组下的版本
4. 点击**部署至生产环境**，监控进度及日志

#### **5.2 标准运维(bk_sops)**

1. 创建应用后，需部署4个模块：
   - **default模块**（必选，优先部署）
   - **api、pipeline、callback模块**（无顺序要求，可并行部署）

**部署步骤示例**：

```
graph TD
    A[部署default模块] --> B[部署api模块]
    A --> C[部署pipeline模块]
    A --> D[部署callback模块]
```

#### **5.3 节点管理(bk_nodeman)**

1. 修改版本号至

   ```
   2.4.4
   ```

   （适配Proxy配置变动）：

   ```
   sed -i 's/bk-nodeman: "2.3.5"/bk-nodeman: "2.4.4"/' environments/default/version.yaml
   grep bk-nodeman environments/default/version.yaml  # 验证修改
   ```

2. 执行Helmfile部署：

   ```
   cd ~/bkce7.1-install/blueking/
   helmfile -f base-blueking.yaml.gotmpl -l name=bk-nodeman sync
   ```

------

### **6. 用户桌面配置**

#### **6.1 自动添加应用**

“一键部署”脚本会自动将标准运维、流程服务及节点管理添加至用户桌面。

#### **6.2 手动添加应用**

```
cd ~/bkce7.1-install/blueking/
# 设置默认应用（对已登录用户无效）
./scripts/set_desktop_default_app.sh -a "bk_itsm,bk_sops,bk_nodeman"
# 为已登录用户admin添加应用
./scripts/add_user_desktop_app.sh -u "admin" -a "bk_itsm,bk_sops,bk_nodeman"
```

**报错处理**：

- 若提示`App(app-code-not-exist) not exists`，检查`app_code`是否正确

------

### **7. 部署后设置**

部分SaaS需初始化配置（如数据库连接、权限映射等），具体参考各应用文档。

------

### **8. 常见问题**

#### **Q1: 部署流程服务时提示“分配不到Redis”**

- 排查步骤：
  1. 检查Redis资源池实例数量是否充足
  2. 确认`redis_password`是否正确解码

#### **Q2: Helmfile部署节点管理失败**

- **可能原因**：域名解析失败或Chart版本不匹配

- 解决方案：

  1. 验证

     ```
     bkrepo.$BK_DOMAIN
     ```

     解析：

     ```
     nslookup bkrepo.$BK_DOMAIN
     ```

  2. 检查`version.yaml`中`bk-nodeman`版本是否为`2.4.4`

------

**附录**：

- [S-Mart包开发规范](https://tencent.yuanbao/链接)
- [蓝鲸PaaS Admin操作手册](https://tencent.yuanbao/链接)

**版本记录**：

- v1.0 - 初始版本
- v1.1 - 补充Redis资源池配置示例







## **十、蓝鲸节点管理（bk_nodeman）部署指南**

### **1. 部署概述**

本指南描述节点管理组件的完整部署流程，包括Agent/插件包上传、接入点配置及K8s集群纳管操作。

------

### **2. 上传Agent及插件包**

#### **2.1 下载Agent包**

在中控机执行以下命令下载最新版Agent（支持Linux x86_64/ARM64、Windows x86_64）：

```
bkdl-7.1-stable.sh -ur latest gse_agent
```

**注意**：

- 若需更新客户端或加装云区域代理，可重新执行此命令下载最新包
- 其他系统架构需联系蓝鲸服务商适配

#### **2.2 上传Agent到节点管理**

```
cd ~/bkce7.1-install/blueking/
./scripts/setup_bkce7.sh -u agent
```

**提示**：

- 脚本会自动覆盖旧版本
- 若需单独更新子模块，参考[插件包管理](https://tencent.yuanbao/chat?from=launch&conversation=d8ce4576-ae33-4f4a-b5e8-738a7ca581c1&project_id=&project_name=&HY82=2&HY56=SlidePage#24-上传gse插件包)

#### **2.3 下载并上传插件包合辑**

```
# 下载包含常用系统架构的插件合辑
bkdl-7.1-stable.sh -ur latest gse_plugins_freq

# 上传至节点管理
cd ~/bkce7.1-install/blueking/
./scripts/setup_bkce7.sh -u plugin
```

**验证上传结果**：
 访问节点管理→插件管理→插件包界面，确认输出日志包含：

```
"message": "all package under path->[/app/official_plugin] is import success, file_count->[1] package_count->[7]"
```

#### **2.4 上传GSE Proxy**

仅支持Linux x86_64架构：

```
# 下载Proxy包
bkdl-7.1-stable.sh -ur latest gse_proxy

# 上传至节点管理
cd ~/bkce7.1-install/blueking/
./scripts/setup_bkce7.sh -u proxy
./scripts/setup_bkce7.sh -u opentools  # 同时上传依赖的开源工具
```

------

### **3. 配置GSE环境管理**

#### **3.1 访问配置界面**

登录蓝鲸桌面→打开“节点管理”应用→顶部导航栏“全局配置”→“GSE环境管理”。

#### **3.2 快速配置场景**

#### **场景A：内网环境使用IP访问**

在中控机执行以下命令生成配置参数：

```
zk_host=$(kubectl get pod -A -l statefulset.kubernetes.io/pod-name=bk-zookeeper-0 -o jsonpath='{.items[0].status.hostIP}')
data_server=$(kubectl get pod -A -l app=gse-data -o jsonpath='{.items[0].status.podIP}')
file_server=$(kubectl get pod -A -l app=gse-file -o jsonpath='{.items[0].status.podIP}')
task_server=$(kubectl get pod -A -l app=gse-cluster -o jsonpath='{.items[0].status.podIP}')
bknodeman_bapi_host=$(kubectl get pod -A -l app.kubernetes.io/component=bk-nodeman-backend-api -o jsonpath='{.items[0].status.hostIP}')
bkrepo_gw_host=$(kubectl get pod -A -l bk.repo.scope=gateway -o jsonpath='{.items[0].status.hostIP}')

cat << EOF
Zookeeper: $zk_host 32181  # 注意使用NodePort 32181
Btfileserver: $file_server
Dataserver: $data_server
Taskserver: $task_server
外网回调地址: http://$bknodeman_bapi_host:30300/backend
Agent包URL: http://$bkrepo_gw_host:30025/generic/blueking/bknodeman/data/bkee/public/bknodeman/download
EOF
```

**配置步骤**：

1. 在节点管理界面填写上述参数
2. 点击“测试Server及URL可用性”
3. 确认“Agent信息”及“Proxy信息”后完成配置

#### **场景B：内网环境使用域名访问**

需提前配置DNS或Hosts解析：

```
cd ~/bkce7.1-install/blueking/
BK_DOMAIN=$(yq e '.domain.bkDomain' environments/default/custom.yaml)
IP1=$(kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx -o jsonpath='{.items[0].status.hostIP}')

cat << EOF
Zookeeper: $zk_host 32181
Btfileserver: $file_server
Dataserver: $data_server
Taskserver: $task_server
外网回调地址: http://bknodeman.$BK_DOMAIN/backend
Agent包URL: http://bkrepo.$BK_DOMAIN/generic/blueking/bknodeman/data/bkee/public/bknodeman/download
EOF
```

**域名解析配置**：

```
echo "$IP1 bkrepo.$BK_DOMAIN" >> /etc/hosts
echo "$IP1 bknodeman.$BK_DOMAIN" >> /etc/hosts
```

------

### **4. K8s集群Agent纳管**

#### **4.1 安装Agent到全部Node**

1. 进入节点管理→“普通安装”界面
2. 选择业务为《蓝鲸》，云区域为“直连区域”
3. 使用默认安装通道及接入点

**特殊场景处理**：

- 若误选《资源池》业务，需手动迁移主机至《蓝鲸》业务：

  ```
  # 在配置平台(CMDB)操作
  1. 进入“资源”→“主机”界面
  2. 全选新安装主机→点击“分配到”→选择“业务空闲机池”
  3. 在弹窗中选择《蓝鲸》业务→确认分配
  ```

#### **4.2 安装监控插件**

参考文档为所有Agent批量安装以下插件：

- `bkmonitorbeat`：主机监控数据采集
- `bkunifylogbeat`：日志采集

------

### **5. 常见问题处理**

#### **Q1: Agent连接GSE服务失败**

- 排查步骤：

  1. 检查“GSE环境管理”配置是否正确

  2. 验证网络连通性：

     ```
     curl -v http://$bknodeman_bapi_host:30300/backend
     ```

#### **Q2: Agent启动失败（报错`agentWorker not found`）**

- 解决方案：

  1. 驱逐Node上的所有Pod：

     ```
     kubectl drain <node-name> --ignore-daemonsets --delete-emptydir-data
     ```

  2. 删除残留状态文件：

     ```
     ssh <node-name> "rm -rf /var/run/ipc.state.report"
     ```

  3. 重新安装Agent后恢复Node调度

------

**附录**：

- [GSE Proxy架构说明](https://tencent.yuanbao/链接)
- [节点管理API文档](https://tencent.yuanbao/链接)

**版本记录**：

- v1.0 - 初始版本
- v1.1 - 补充域名解析配置示例





## **十一、蓝鲸容器管理套餐部署指南**

### **1. 部署概述**

本指南描述容器管理套餐的完整部署流程，包括存储配置、CoreDNS优化、平台部署及标准运维流程导入。

------

### **2. 存储配置检查与调整**

#### **2.1 检查当前StorageClass**

在中控机执行以下命令：

```
kubectl get sc
```

**预期输出**：

```
NAME              PROVISIONER                 RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
local-storage     kubernetes.io/no-provisioner   Delete          WaitForFirstConsumer   false                  3d21h
```

#### **2.2 修改默认StorageClass（如需）**

若输出名称非`local-storage`，需创建自定义配置：

```
cd ~/bkce7.1-install/blueking/
cat << EOF >> environments/default/custom.yaml
bcs:
  storageClass: <查询到的StorageClass名称>
EOF
```

------

### **3. 禁用消息队列（BCS服务栈1.28.2及以下版本）**

为避免`bcs-storage` CPU使用率异常，需禁用消息队列：

```
# 创建或编辑自定义Values文件
vim ./environments/default/bcs-custom-values.yaml.gotmpl
```

**添加以下内容**：

```
bcs-storage:
  storage:
    messageQueue:
      enabled: false
global:
  storage:
    messageQueue:
      enabled: false
```

------

### **4. CoreDNS配置优化**

确保容器管理平台能访问蓝鲸制品库的Helm及Docker仓库：

```
cd ~/bkce7.1-install/blueking/
BK_DOMAIN=$(yq e '.domain.bkDomain' environments/default/custom.yaml)
IP1=$(kubectl get svc -A -l app.kubernetes.io/instance=ingress-nginx -o jsonpath='{.items[0].spec.clusterIP}')

# 更新CoreDNS记录
./scripts/control_coredns.sh update "$IP1" bcs.$BK_DOMAIN bcs-api.$BK_DOMAIN docker.$BK_DOMAIN helm.$BK_DOMAIN

# 验证记录
./scripts/control_coredns.sh list
```

------

### **5. 部署容器管理平台**

#### **5.1 执行部署命令**

```
cd ~/bkce7.1-install/blueking/
helmfile -f 03-bcs.yaml.gotmpl sync
```

#### **5.2 桌面应用配置**

```
# 为admin用户添加桌面应用
scripts/add_user_desktop_app.sh -u "admin" -a "bk_bcs"

# 设为默认应用
scripts/set_desktop_default_app.sh -a "bk_bcs"
```

#### **5.3 部署监控**

- **耗时**：3~7分钟

- 监控Pod状态

  （另起终端执行）：

  ```
  kubectl get pod -n bcs-system -w
  ```

- **故障排查**：若部署失败，查阅《容器管理平台问题排查指南》。

------

### **6. 导入标准运维流程**

#### **6.1 流程导入步骤**

1. 使用admin账户登录蓝鲸桌面
2. 进入**标准运维**→**公共流程管理**→点击**导入**按钮
3. 选择**导入DAT文件**，上传流程定义文件

#### **6.2 冲突处理**

若提示流程ID冲突：

- 点击**覆盖冲突项并提交**按钮

**关键提示**：

- 未导入流程或ID错误会导致新建集群报错：
   `CreateBkOpsTask err: Object not found: CommonTemplate(id=10001) does not exist`

------

### **7. 域名配置**

确保以下域名已正确解析至集群Ingress-Nginx IP：

- `bcs.$BK_DOMAIN`
- `bcs-api.$BK_DOMAIN`

> **操作参考**：
>  详见《部署步骤详解——后台》文档中域名配置章节

------

### **8. Helm仓库初始化**

首次访问Helm仓库时需手动触发同步：

1. 登录容器管理平台
2. 进入**Helm**→**Chart仓库**
3. 点击**创建**按钮加载公共仓库列表

**注意**：

- 项目仓库初始为空，需参考文档[上传私有Chart](https://tencent.yuanbao/链接)

------

### **9. 容器监控数据上报**

完成以下操作后，集群总览和节点管理监控图表将显示数据：

1. 部署蓝鲸监控套餐
2. 完成[容器监控数据上报配置](https://tencent.yuanbao/链接)

------

### **10. 常见问题处理**

#### **Q1: 部署失败且Pod异常**

- 排查步骤：

  1. 检查CoreDNS解析是否正常：

     ```
     kubectl run -it --rm debug --image=busybox --restart=Never -- nslookup bcs.$BK_DOMAIN
     ```

  2. 查看部署日志：

     ```
     kubectl logs -n bcs-system deploy/bcs-controller-manager
     ```

#### **Q2: 新建集群时报错“流程模板不存在”**

- 解决方案：
  1. 确认标准运维流程已成功导入
  2. 检查流程ID是否匹配（预期ID：10001）

------

**附录**：

- [BCS存储配置最佳实践](https://tencent.yuanbao/链接)
- [CoreDNS高级配置指南](https://tencent.yuanbao/链接)

**版本记录**：

- v1.0 - 初始版本
- v1.1 - 补充域名冲突处理流程





## **十二、蓝鲸监控日志套餐部署指南**

### **1. 部署概述**

本指南描述蓝鲸监控日志套餐（含监控平台与日志平台）的完整部署流程，包含依赖检查、存储配置、平台部署及功能扩展。

------

### **2. 部署前准备**

#### **2.1 版本依赖检查**

在中控机执行以下命令验证环境版本：

```
# 检查蓝鲸版本（需≥7.1.3）
cd ~/bkce7.1-install/blueking/ && cat VERSION

# 检查GSE版本（需≥2.1.2-beta.20）
helm list -A -l name=bk-gse | awk '{print $2}'

# 检查APIGateway版本（需≥1.11.3）
helm list -A -l name=bk-apigateway | awk '{print $2}'
```

**版本不达标时**：重新执行基础套餐部署命令升级环境。

------

### **3. 监控平台部署**

#### **3.1 存储服务配置**

```
cd ~/bkce7.1-install/blueking/
helmfile -f monitor-storage.yaml.gotmpl sync  # 部署监控依赖的存储
```

#### **3.2 容器管理平台对接**

```
./scripts/config_monitor_bcs_token.sh  # 获取BCS Token并写入配置
```

#### **3.3 核心组件部署**

```
helmfile -f 04-bkmonitor.yaml.gotmpl sync  # 部署监控后台及数据链路组件
```

**预期耗时**：5-10分钟
 ​**常见问题**​：

- `bk-monitor-consul` Pod异常重启属正常现象
- 若部署失败，查阅《问题案例》文档后重试

#### **3.4 桌面应用配置**

```
# 添加监控平台应用（含故障自愈）
scripts/add_user_desktop_app.sh -u "admin" -a "bk_monitorv3"
scripts/set_desktop_default_app.sh -a "bk_monitorv3"
scripts/add_user_desktop_app.sh -u "admin" -a "bk_fta_solution"
scripts/set_desktop_default_app.sh -a "bk_fta_solution"
```

------

### **4. 日志平台部署**

#### **4.1 ElasticSearch配置优化**

```
# 禁止自动创建write_*索引
kubectl exec -it -n blueking bk-elastic-elasticsearch-master-0 -- \
  curl -X PUT -u elastic:blueking http://127.0.0.1:9200/_cluster/settings \
  -H 'Content-Type: application/json' \
  -d '{"persistent":{"action":{"auto_create_index":"-write_*,*"}}}'
```

#### **4.2 日志采集器部署**

```
cd ~/bkce7.1-install/blueking/
helmfile -f 04-bklog-collector.yaml.gotmpl sync  # 部署日志采集器
```

**验证**：检查各Node节点GSE Agent状态是否正常。

#### **4.3 平台部署与访问**

```
cd ~/bkce7.1-install/blueking/
helmfile -f 04-bklog-search.yaml.gotmpl sync  # 部署日志平台
scripts/add_user_desktop_app.sh -u "admin" -a "bk_log_search"
scripts/set_desktop_default_app.sh -a "bk_log_search"
```

**域名配置**：参考《部署步骤详解——后台》完成`bklog.$BK_DOMAIN`解析。

------

### **5. 高级功能配置**

#### **5.1 容器监控数据上报**

```
# 创建自定义配置文件
touch environments/default/bkmonitor-operator-custom-values.yaml.gotmpl
yq -i '.bkmonitor-operator-charts.bkmonitor-operator.builtinLabels = ["instance"]' \
  environments/default/bkmonitor-operator-custom-values.yaml.gotmpl

# 部署Operator
helmfile -f 04-bkmonitor-operator.yaml.gotmpl sync
```

**生效时间**：1-11分钟（刷新页面查看集群信息）

------

### **6. 应用监控（APM）**

#### **6.1 自定义上报服务器部署**

通过节点管理安装`bk-collector`插件：

1. 登录节点管理系统
2. 在“插件状态”界面选择服务器
3. 安装`bk-collector`插件并确认版本

#### **6.2 监控平台全局配置**

```
cd ~/bkce7.1-install/blueking/
# 设置OTel服务端IP（多个IP需逐行填写）
vim environments/default/custom.yaml
# 添加配置项：
custom:
  otel_server_ips: ["<IP1>", "<IP2>"]
```

------

### **7. 蓝鲸服务SLI看板**

#### **7.1 启用前提条件**

- 预留300G磁盘空间与4GB内存余量
- 使用SSD存储

#### **7.2 配置步骤**

```
# 启用指标上报
cd ~/bkce7.1-install/blueking/
case $(yq e '.serviceMonitor.enabled' environments/default/custom.yaml) in
  null) tee -a environments/default/custom.yaml <<< "serviceMonitor:\n  enabled: true" ;;
  true) echo "已启用，无需修改" ;;
  *) echo "需手动修改为true" ;;
esac

# 重启相关Release
helmfile -f base-blueking.yaml.gotmpl apply
helmfile -f 03-bcs.yaml.gotmpl apply
helmfile -f 04-bkmonitor.yaml.gotmpl apply
helmfile -f 04-bklog-search.yaml.gotmpl apply
```

------

### **8. 日志采集与上报**

#### **8.1 前置检查**

```
# 检查CRD是否存在
kubectl get crd bklogconfigs.bk.tencent.com
```

**预期输出**：显示`bklogconfigs.bk.tencent.com`记录

#### **8.2 全局启用日志上报**

```
cd ~/bkce7.1-install/blueking/
case $(yq e '.bkLogConfig.enabled' environments/default/custom.yaml) in
  null) tee -a environments/default/custom.yaml <<< "bkLogConfig:\n  enabled: true" ;;
  true) echo "已启用，无需修改" ;;
  *) echo "需手动修改为true" ;;
esac

# 重启日志平台及依赖服务
helmfile -f 04-bklog-search.yaml.gotmpl apply
helmfile -f base-blueking.yaml.gotmpl apply
helmfile -f 03-bcs.yaml.gotmpl apply
helmfile -f 04-bkmonitor.yaml.gotmpl apply
```

**生效时间**：10分钟左右（检查索引集数据）

------

### **9. 常见问题处理**

#### **Q1: 监控平台访问报HTTP 503**

- 排查步骤：

  1. 检查CoreDNS解析是否正常

  2. 查看

     ```
     bk-monitor-consul
     ```

      Pod日志：

     ```
     kubectl logs -n bcs-system deploy/bk-monitor-consul
     ```

#### **Q2: 日志采集器启动失败**

- 解决方案：

  1. 确认GSE Agent状态：

     ```
     kubectl get pods -n blueking -l app=bk-gse-agent
     ```

  2. 检查节点网络连通性

------

**附录**：

- [蓝鲸监控API文档](https://tencent.yuanbao/链接)
- [ElasticSearch性能调优指南](https://tencent.yuanbao/链接)

**版本记录**：

- v1.0 - 初始版本
- v1.1 - 补充SLI看板磁盘要求



## **十三、FAQ**

**持续更新**

#### **1. 社区问答链接**

https://bk.tencent.com/s-mart/community/question/11548



#### **2. 安装paas的时候一直卡在bkpaas3-apiserver-init-data这个job过不去**

排查思路:

1、先查看对应job的日志，看是否有报错，如果看不懂，可以到bkpaas3-apiserver-web这个pod去执行一下bash -x init.sh这个脚本看看是哪条命令的问题。这个大概率的问题是因为服务器不能连外网，是通过proxy去连的，这样容器就连不上外网，他需要去蓝鲸官网拉取slug-app这个镜像，因为连不上外网，会一直报错拉取镜像失败。

解决方案：

找个可以连接外网的机器把镜像下载到本地

```shell
docker pull hub.bktencent.com/blueking/slug-app:v1.1.0-beta.27
```

然后上传到上面部署好的蓝鲸制品库上，或者其他的镜像仓库都可以

```shell
docker tag hub.bktencent.com/blueking/slug-app:v1.1.0-beta.27 docker.www.itserver.com/bkpaas/docker/slug-pilot:heroku-18-v1.6.1
```

然后修改paas的cm，bkpaas3-apiserver-general-env，把下面地址修改成对应的镜像仓库就可以

```shell
PAAS_APP_IMAGE: docker.www.itserver.com:80/bkpaas/docker/slug-pilot:heroku-18-v1.6.1
```

然后删除bkpaas3-apiserver-web这个pod，让他重新跑即可。

这一步如果不处理的话，会影响到后续的saas部署。

#### **3. 安装容器平台的时候会卡在bcs-services-stack-mariadb这个pod**

排查思路:

1、先查看对应pod日志：
error: 'Can't connect to local MySQL server through socket '/opt/bitnami/mariadb/tmp/mysql.sock' (2)'

 

解决方案：

看着是mysql没起来

进到pod里面手动拉起即可，进pod操作：

```shell
cd /opt/bitnami/scripts/mariadb
nohup /opt/bitnami/scripts/mariadb/run.sh &
```




# 卸载

需要卸载访问蓝鲸官网，按文档操作即可，卸载文档：
https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/uninstall.md
